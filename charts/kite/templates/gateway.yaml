{{- if .Values.gateway.enabled -}}
{{- if .Values.gateway.create }}
---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: {{ .Values.gateway.name | default (include "kite.fullname" .) }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kite.labels" . | nindent 4 }}
  {{- with .Values.gateway.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  gatewayClassName: {{ .Values.gateway.className | required "gateway.className is required when gateway.enabled is true" }}
  {{- with .Values.gateway.listeners }}
  listeners:
    {{- range . }}
    - name: {{ .name }}
      port: {{ .port }}
      protocol: {{ .protocol }}
      {{- with .hostname }}
      hostname: {{ . | quote }}
      {{- end }}
      {{- with .allowedRoutes }}
      allowedRoutes:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if eq .protocol "HTTPS" }}
      {{- with .tls }}
      tls:
        {{- if .mode }}
        mode: {{ .mode }}
        {{- end }}
        {{- with .certificateRefs }}
        certificateRefs:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}
{{- range .Values.gateway.httpRoutes }}
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ .name | required "httpRoute name is required" }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "kite.labels" $ | nindent 4 }}
  {{- with .annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  parentRefs:
    - name: {{ $.Values.gateway.name | default (include "kite.fullname" $) }}
      {{- if and (not $.Values.gateway.create) $.Values.gateway.namespace }}
      namespace: {{ $.Values.gateway.namespace }}
      {{- end }}
  {{- with .hostnames }}
  hostnames:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  rules:
    {{- range .rules }}
    - matches:
        {{- range .matches }}
        - {{- if .path }}
          path:
            type: {{ .path.type | default "PathPrefix" }}
            value: {{ .path.value | default "/" }}
          {{- end }}
          {{- with .headers }}
          headers:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .queryParams }}
          queryParams:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .method }}
          method: {{ . }}
          {{- end }}
        {{- end }}
      backendRefs:
        - name: {{ include "kite.fullname" $ }}
          port: {{ $.Values.service.port }}
    {{- end }}
{{- end }}
{{- end }}
